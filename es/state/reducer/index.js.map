{"version":3,"sources":["../../../src/state/reducer/index.js"],"names":["combineReducers","createReducer","append","contains","without","map","takeLast","pipe","concat","tail","head","remove","trimType","toUID","MAIN","NET","API","keyStorage","KeyStorage","KeyValue","sha1BytesSync","NetMessage","requestWatch","ApiRequest","Config","initial","trimAction","action","type","progress","idle","current","done","result","TASK","DONE","state","payload","apiPL","onlyAPI","newState","reduce","reduceResults","empty","reducer","acc","val","id","api","apiID","data","body","init","list","maybeGetK","fold","x","snd","saved","res","push","findReq","req","requestID","units","filter","p","flags","resolved","getReqIDs","unitReduce","unit","newIdle","newCurrent","newDone","find","inIdle","findIndex","inCurrent","watcher","currentState","length","newNext","ids","update","uid","INIT","ackDefault","pendingAck","ACK_ADD","dc","ack","dcAcks","updated","Set","ACK_DELETE","RECOVERY_MODE","halt","recovery","homeDc","STORAGE_IMPORTED","home","DC_DETECTED","DC_CHANGED","newDC","dcDetected","DC_REJECTED","lastMessages","authData","salt","AUTH","RESOLVE","set","serverSalt","merge","summary","auth","authKey","authID","makeAuthID","authKeyID","Array","isArray","slice","commandReducer","apiRequests","msg","isAPI","msg_id","clientRequest","REQUEST","NEW","netReq","client","command","request","status","homeStatus","statusWatch","dcList","singleStatus","has","kv","decoratedClient","clientReducer","oldValue","newValue","idsReducer","mainReducer"],"mappings":"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","file":"index.js","sourcesContent":["//@flow\n\n/* eslint-disable object-shorthand */\n\nimport { combineReducers, type Reducer } from 'redux'\nimport { createReducer } from 'redux-act'\nimport {\n  append,\n  contains,\n  without,\n  map,\n  takeLast,\n  pipe,\n  concat,\n  tail,\n  head,\n  remove,\n} from 'ramda'\n// import { Pure, liftF } from '@safareli/free'\n// import { of, Left, Right } from 'apropos'\n// import { Maybe } from 'folktale/maybe'\nimport type {\n  ApiNewRequest,\n  State,\n  Client,\n  ClientList,\n  InitType,\n  OnAckAdd,\n  OnStorageImported,\n  OnRecovery,\n  OnDcDetected,\n} from '../index.h'\nimport {\n  trimType,\n} from '../helpers'\nimport {\n  type UID,\n  toUID,\n  type DCNumber,\n} from 'Newtype'\nimport { MAIN, NET, API } from 'Action'\nimport keyStorage, { KeyStorage } from 'Util/key-storage'\nimport { KeyValue } from 'Monad'\nimport { sha1BytesSync } from 'Bin'\nimport { NetMessage } from '../../service/networker/net-message'\nimport requestWatch from './request'\nimport ApiRequest from '../../service/main/request'\nimport Config from 'ConfigProvider'\n\nimport {\n  type PUnitList,\n  type MessageUnit,\n} from '../../task/index.h'\n\nconst initial: any = {}\n\ndeclare var req: ApiRequest\n\nfunction trimAction(action: any): string {\n  return trimType(action.type)\n}\n\ntype RequestResult = { +_: string, +[key: string]: any }\n\nconst progress = (() => {\n\n  const idle = createReducer({}, [])\n  const current = createReducer({}, [])\n  const done = createReducer({}, [])\n  const result = createReducer({\n    //$off\n    [API.TASK.DONE]: (\n      state: KeyValue<string, RequestResult[]>,\n      payload: MessageUnit[]\n    ): KeyValue<string, RequestResult[]> => {\n      const apiPL = onlyAPI(payload)\n      const newState = apiPL.reduce(reduceResults, state)\n      return newState\n    }\n  }, KeyValue.empty())\n  type Progress = {\n    idle: ApiRequest[],\n    current: ApiRequest[],\n    done: ApiRequest[],\n    result: KeyValue<string, RequestResult[]>,\n  }\n  const reducer: Reducer<Progress> = combineReducers({\n    idle,\n    current,\n    done,\n    result,\n  })\n\n  function reduceResults(\n    acc: KeyValue<string, RequestResult[]>,\n    val: MessageUnit\n  ) {\n    const id = val.api.apiID\n    const data = val.body\n    const init: RequestResult[] = []\n    const list = acc\n      .maybeGetK(id)\n      .fold(() => init, x => x.snd())\n    const saved = append(data, list)\n    const res = acc.push([[id, saved]])\n    return res\n  }\n\n  const findReq = (id: string) => (req: ApiRequest) => req.requestID === id\n  const onlyAPI = (units: MessageUnit[]) => units\n    .filter(p => p.flags.api && p.api.resolved)\n  const getReqIDs = (list: ApiRequest[]) => list.map(req => req.requestID)\n\n  function unitReduce({ idle, current, done, result }: Progress, unit: MessageUnit) {\n    const id = unit.api.apiID\n    let newIdle = idle\n    let newCurrent = current\n    let newDone = done\n    const find = findReq(id)\n    const inIdle = newIdle.findIndex(find)\n    const inCurrent = newCurrent.findIndex(find)\n    if (inIdle > -1) {\n      const req = newIdle[inIdle]\n      newIdle = remove(inIdle, 1, newIdle)\n      newDone = append(req, newDone)\n    }\n    if (inCurrent > -1) {\n      const req = newCurrent[inCurrent]\n      newCurrent = remove(inCurrent, 1, newCurrent)\n      newDone = append(req, newDone)\n    }\n    return {\n      idle   : newIdle,\n      current: newCurrent,\n      done   : newDone,\n      result,\n    }\n  }\n\n  return function watcher(\n    currentState: Progress,\n    action: any\n  ): Progress {\n    const state: Progress = reducer(currentState, action)\n    const { idle, current, done, result } = state\n    switch (trimAction(action)) {\n      case 'api/next': {\n        if (idle.length === 0) return state\n        if (current.length > 0) return state\n        const newNext: ApiRequest = head(idle) /*:: || req */\n        const newState = {\n          idle   : tail(idle),\n          current: append(newNext, current),\n          done,\n          result,\n        }\n        return newState\n      }\n      case 'api/task new': {\n        const ids = getReqIDs(idle)\n          .concat(\n            getReqIDs(current),\n          )\n        const payload: ApiRequest[] = action.payload\n        const update = payload.filter(req => !contains(req.requestID, ids))\n        const newIdle = idle.concat(update)\n        return {\n          idle: newIdle,\n          current,\n          done,\n          result\n        }\n      }\n      case 'api/task done': {\n        const payload: MessageUnit[] = action.payload\n        const apiPL = onlyAPI(payload)\n        const newState: Progress = apiPL.reduce(unitReduce, state)\n        return newState\n      }\n      default: return state\n    }\n  }\n})()\n\n\n\nconst uid = createReducer({\n  //$FlowIssue\n  [MAIN.INIT]: (state: string, payload: InitType) => payload.uid,\n}, '')\n\ntype AckMap = { [dc: number]: string[] }\n\nconst ackDefault: AckMap = initial\nconst pendingAck = createReducer({\n  //$off\n  [NET.ACK_ADD]: (state: AckMap, { dc, ack }: OnAckAdd): AckMap => {\n    const dcAcks = state[dc] || []\n    const updated = [...new Set([...dcAcks, ...ack])]\n    return { ...state, [dc | 0]: updated }\n  },\n  //$off\n  [NET.ACK_DELETE]: (state: AckMap, { dc, ack }: OnAckAdd): AckMap => {\n    const dcAcks = state[dc] || []\n    const updated = without(ack, dcAcks)\n    return { ...state, [dc | 0]: updated }\n  },\n  //$off\n  [MAIN.RECOVERY_MODE]: (state: AckMap, { halt, recovery }: OnRecovery): AckMap =>  ({\n    ...state,\n    [halt]: [],\n  })\n}, ackDefault)\n\nconst homeDc = createReducer({\n  //$off\n  [MAIN.STORAGE_IMPORTED]: (state: number, { home }: OnStorageImported) => home,\n  //$off\n  [MAIN.DC_DETECTED]     : (state: number, { dc }: OnDcDetected) => dc,\n  //$FlowIssue\n  [MAIN.DC_CHANGED]      : (state: number, { newDC }: OnDcDetected) => newDC,\n}, 2)\n\nconst dcDetected = createReducer({\n  //$off\n  [MAIN.DC_DETECTED]: () => true,\n  //$off\n  [MAIN.DC_REJECTED]: () => false,\n}, false)\n\n\nconst lastMessages = createReducer({\n  //$off\n  [API.TASK.DONE]: (state: UID[], payload: MessageUnit[]): UID[] => pipe(\n    map(unit => /*:: toUID( */ unit.id /*:: ) */),\n    concat(state),\n    takeLast(100),\n  )(payload)\n}, [])\n\nconst authData = (() => {\n  const salt = createReducer({\n    //$off\n    [MAIN.AUTH.RESOLVE]    : (state: KeyStorage, payload: OnAuthResolve) => state.set(payload.dc, payload.serverSalt),\n    //$off\n    [MAIN.STORAGE_IMPORTED]: (state: KeyStorage, { salt }: OnStorageImported) => state.merge(salt),\n    '[01] action carrier'  : (state: KeyStorage, payload: PUnitList) => state.merge(payload.summary.salt),\n    //$off\n    [MAIN.RECOVERY_MODE]   : (state: KeyStorage, { halt, recovery }: OnRecovery): KeyStorage =>\n      state.remove(halt)\n  }, keyStorage())\n\n  const auth = createReducer({\n    //$off\n    [MAIN.STORAGE_IMPORTED]: (state: KeyStorage, { auth }: OnStorageImported) => state.merge(auth),\n    '[01] action carrier'  : (state: KeyStorage, payload: PUnitList) => state.merge(payload.summary.auth),\n    //$off\n    [MAIN.AUTH.RESOLVE]    : (state: KeyStorage, payload: OnAuthResolve) => state.set(payload.dc, payload.authKey),\n    //$off\n    [MAIN.RECOVERY_MODE]   : (state: KeyStorage, { halt, recovery }: OnRecovery): KeyStorage =>\n      state.remove(halt)\n  }, keyStorage())\n\n  const authID = createReducer({\n    //$off\n    [MAIN.STORAGE_IMPORTED]: (state: KeyStorage, { auth }: OnStorageImported) => state.merge(map(makeAuthID, auth)),\n    '[01] action carrier'  : (state: KeyStorage, payload: PUnitList) =>\n    //$off\n      state.merge(map(makeAuthID, payload.summary.auth)),\n    //$off\n    [MAIN.AUTH.RESOLVE] : (state: KeyStorage, payload: OnAuthResolve) => state.set(payload.dc, payload.authKeyID),\n    //$off\n    [MAIN.RECOVERY_MODE]: (state: KeyStorage, { halt, recovery }: OnRecovery): KeyStorage =>\n      state.remove(halt)\n  }, keyStorage())\n\n  const makeAuthID = (auth: number[] | false): number[] | false => Array.isArray(auth)\n    ? sha1BytesSync(auth).slice(-8)\n    : false\n\n  return { auth, salt, authID }\n})()\n\nfunction commandReducer(\n  state: KeyValue<string, string> = KeyValue.empty(),\n  action: any\n): KeyValue<string, string> {\n  switch ( trimType(action.type) ) {\n    case 'networker/sent add': {\n      const payload: NetMessage[] = action.payload\n      const apiRequests = payload\n        .filter(msg => msg.isAPI)\n        .map(({ msg_id, requestID }) => [msg_id, requestID || ''])\n      return state.push(apiRequests)\n    }\n    case 'main/recovery mode': return state\n    default: return state\n  }\n}\n\nconst clientRequest = createReducer({\n  //$off\n  [API.REQUEST.NEW]: (\n    state: KeyValue<UID, ApiRequest>,\n    { netReq }: ApiNewRequest\n  ): KeyValue<UID, ApiRequest> =>\n    state.push([[netReq.requestID, netReq]])\n}, KeyValue.empty())\n\nconst client: Reducer<Client> = combineReducers({\n  uid,\n  homeDc,\n  progress,\n  command   : commandReducer,\n  request   : clientRequest,\n  lastMessages,\n  dcDetected,\n  ...authData,\n  pendingAck,\n  status    : createReducer({}, {}),\n  homeStatus: createReducer({}, false),\n})\n\nfunction statusWatch(state: Client) {\n  const dcList = Config.dcList(state.uid)\n  const singleStatus = dc =>\n    state.auth.has(dc)\n    && state.authID.has(dc)\n    && state.salt.has(dc)\n  const kv: KeyValue<DCNumber, boolean> = KeyValue.empty()\n  return kv.push(\n    dcList\n      .map(dc => [dc, singleStatus(dc)]))\n}\n\nfunction decoratedClient(state: Client, action: $off): Client {\n  const currentState = requestWatch(client(state, action), action)\n  const status = statusWatch(currentState)\n  const homeStatus = status\n    .maybeGetK(currentState.homeDc)\n    .fold(() => false, x => x.snd())\n  return {\n    ...currentState,\n    status,\n    homeStatus,\n  }\n}\n\nconst clientReducer: Reducer<ClientList> = (state: ClientList = { ids: [] }, action: any) => {\n  if (typeof action.uid !== 'string') return state\n  const uid: string = action.uid\n  const oldValue = state[uid]\n  const newValue = decoratedClient(oldValue, action)\n  if (oldValue === newValue) return state\n  return {\n    ...state,\n    [uid]: newValue,\n    ids  : idsReducer(state.ids, uid)\n  }\n}\n\nfunction idsReducer(state: string[], uid: string): string[] {\n  return contains(uid, state)\n    ? state\n    : append(uid, state)\n}\n\nconst mainReducer: Reducer<State> = combineReducers({\n  client: clientReducer,\n})\n\nexport default mainReducer\n"]}
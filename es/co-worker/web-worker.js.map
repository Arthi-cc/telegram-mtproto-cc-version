{"version":3,"sources":["../../src/co-worker/web-worker.js"],"names":["blueDefer","Logger","log","Webworker","of","constructor","taskCount","awaiting","initWorker","worker","postMessage","getNextID","run","taskType","data","task","taskID","addTaskAwait","promise","getWorker","onmessage","isCryptoTask","resolveTask","result","onerror","err","defer","resolve","obj","WorkerInstance","require","console","error"],"mappings":"AAEA,OAAOA,SAAP;AACA,OAAOC,MAAP;AACA,IAAMC,MAAMD,MAAO,YAAnB;;AAKA,eAAe,MAAME,SAAN,CAAgB;AAC7B,SAAOC,EAAP,GAAY;AACV,WAAO,IAAID,SAAJ,EAAP;AACD;;AAQDE,gBAAc;AAAA,SANdC,SAMc,GANM,CAMN;AAAA,SAJdC,QAIc,GAFV,EAEU;;AACZ,SAAKC,UAAL;AACA,SAAKC,MAAL,CAAYC,WAAZ,CAAwB,GAAxB;AACD;;AAEDC,cAAY;AACV,WAAO,KAAKL,SAAL,EAAP;AACD;;AAEDM,MAAIC,QAAJ,EAAyBC,IAAzB,EAAkC;AAChC,QAAMC,OAAa;AACjBA,YAAQF,QADS;AAEjBG,cAAQ,KAAKL,SAAL,EAFS;AAGjBG;AAHiB,KAAnB;AAKA,WAAO,KAAKG,YAAL,CAAkBF,IAAlB,CAAP;AACD;;AAEDE,eAAaF,IAAb,EAAyB;AACvB,SAAKR,QAAL,CAAcQ,KAAKC,MAAnB,IAA6BhB,WAA7B;AACA,SAAKS,MAAL,CAAYC,WAAZ,CAAwBK,IAAxB;AACA,WAAO,KAAKR,QAAL,CAAcQ,KAAKC,MAAnB,EAA2BE,OAAlC;AACD;;AAEDV,eAAa;AACX,SAAKC,MAAL,GAAcU,WAAd;;AAkBA,SAAKV,MAAL,CAAYW,SAAZ,GAhBkB,CAAC,EAAEN,IAAF,EAAD,KAA0B;AAC1C,UAAI,OAAOA,IAAP,KAAgB,QAApB,EAA8B;AAC5BA,iBAAS,OAAT,GACIZ,GAAI,MAAJ,CAAU,UAAV,CADJ,GAEIA,GAAI,MAAJ,CAAU,wBAAV,EAAoCY,IAApC,CAFJ;AAGD,OAJD,MAIO,IAAI,CAACO,aAAaP,IAAb,CAAL,EAAyB;AAC9BZ,WAAI,MAAJ,CAAU,iBAAV,EAA6BY,IAA7B;AACD,OAFM,MAEA;AACL,aAAKQ,WAAL,CAAiBR,KAAKE,MAAtB,EAA8BF,KAAKS,MAAnC;AACD;AACF,KAMD;AACA,SAAKd,MAAL,CAAYe,OAAZ,GALiBC,GAAD,IAAgB;AAC9BvB,SAAI,OAAJ,CAAWuB,GAAX;AACD,KAGD;AACD;;AAEDH,cAAYN,MAAZ,EAA4BO,MAA5B,EAAuC;AACrC,QAAMG,QAAQ,KAAKnB,QAAL,CAAcS,MAAd,CAAd;AACA,QAAI,CAACU,KAAL,EAAY;AACVxB,SAAI,qBAAJ,CAA0B,kBAAiBc,MAAO,QAAlD;AACA;AACD;AACD,WAAO,KAAKT,QAAL,CAAcS,MAAd,CAAP;AACAU,UAAMC,OAAN,CAAcJ,MAAd;AACD;AAlE4B;;AAqE/B,SAASF,YAAT,CAAsBO,GAAtB,EAA8D;AAC5D,SACE,OAAOA,GAAP,KAAe,QAAf,IACA,OAAOA,IAAIZ,MAAX,KAAsB,QAFxB;AAID;;AAED,SAASG,SAAT,GAAiC;AAC/B,MAAIU,uBAAJ;AACA,MAAI;AACF;AACAA,qBAAiBC,OAAjB;AACD,GAHD,CAGE,OAAOL,GAAP,EAAY;AACZM,YAAQC,KAAR,CAAcP,GAAd;AACAI,qBAAiBC,QAAQ,aAAR,CAAjB;AACD;AACD;AACA,MAAMrB,SAAS,IAAIoB,cAAJ,EAAf;AACA,SAAOpB,MAAP;AACD","file":"web-worker.js","sourcesContent":["//@flow\n\nimport blueDefer, { type Defer } from 'Util/defer'\nimport Logger from 'mtproto-logger'\nconst log = Logger`web-worker`\n\nimport type { TasksType, WorkerType, Task, TaskResult } from './index.h'\n\n\nexport default class Webworker {\n  static of() {\n    return new Webworker\n  }\n\n  taskCount: number = 0\n  worker: WorkerType\n  awaiting: {\n    [task: number]: Defer\n  } = {}\n\n  constructor() {\n    this.initWorker()\n    this.worker.postMessage('b')\n  }\n\n  getNextID() {\n    return this.taskCount++\n  }\n\n  run(taskType: TasksType, data: *) {\n    const task: Task = {\n      task  : taskType,\n      taskID: this.getNextID(),\n      data,\n    }\n    return this.addTaskAwait(task)\n  }\n\n  addTaskAwait(task: Task) {\n    this.awaiting[task.taskID] = blueDefer()\n    this.worker.postMessage(task)\n    return this.awaiting[task.taskID].promise\n  }\n\n  initWorker() {\n    this.worker = getWorker()\n\n    const onmessage = ({ data }: TaskResult) => {\n      if (typeof data === 'string') {\n        data === 'ready'\n          ? log`init`('CW ready')\n          : log`init`('Unknown worker message', data)\n      } else if (!isCryptoTask(data)) {\n        log`init`('Not crypto task', data)\n      } else {\n        this.resolveTask(data.taskID, data.result)\n      }\n    }\n\n    const onerror = (err: Error) => {\n      log`error`(err)\n    }\n\n    this.worker.onmessage = onmessage\n    this.worker.onerror = onerror\n  }\n\n  resolveTask(taskID: number, result: *) {\n    const defer = this.awaiting[taskID]\n    if (!defer) {\n      log`resolve task, error`(`No stored task ${taskID} found`)\n      return\n    }\n    delete this.awaiting[taskID]\n    defer.resolve(result)\n  }\n}\n\nfunction isCryptoTask(obj: $PropertyType<TaskResult, 'data'>) {\n  return (\n    typeof obj === 'object' &&\n    typeof obj.taskID === 'number'\n  )\n}\n\nfunction getWorker(): WorkerType {\n  let WorkerInstance\n  try {\n    //$FlowIssue\n    WorkerInstance = require('worker-loader?inline&fallback=false!./worker.js')\n  } catch (err) {\n    console.error(err)\n    WorkerInstance = require('./worker.js')\n  }\n  //$FlowIssue\n  const worker = new WorkerInstance()\n  return worker\n}\n"]}
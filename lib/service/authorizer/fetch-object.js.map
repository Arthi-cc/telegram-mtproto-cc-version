{"version":3,"sources":["../../../src/service/authorizer/fetch-object.js"],"names":["writeReqPQ","writeReqDH","writeInnerDH","fetchDHInner","reader","fetchObject","fetchDhParam","fetchServerDh","fetchResPQ","uid","nonce","request","mtproto","storeMethod","writer","getBuffer","auth","serverNonce","publicKey","pq","p","q","newNonce","data","storeObject","_","server_nonce","new_nonce","hash","getBytesPlain","dataWithHash","concat","public_key_fingerprint","fingerprint","encrypted_data","gB","retry_id","retry","g_b"],"mappings":";;;;;;QAgCgBA,U,GAAAA,U;QAMAC,U,GAAAA,U;QAiDAC,Y,GAAAA,Y;;AArFhB;;AACA;;AAEA;;AAMA;;AAIO,IAAMC,sCAAe,CAACC;AAC3B;AAD0B,KAE1BA,OAAOC,WAAP,CAAmB,sBAAnB,EAA2C,WAA3C,CAFK;;AAIA,IAAMC,sCAAe,CAACF;AAC3B;AAD0B,KAE1BA,OAAOC,WAAP,CAAmB,6BAAnB,EAAkD,WAAlD,CAFK;;AAIA,IAAME,wCAAgB,CAACH;AAC5B;AAD2B,KAE3BA,OAAOC,WAAP,CAAmB,kBAAnB,EAAuC,UAAvC,CAFK;;AAIA,IAAMG,kCAAa,CAACJ;AACzB;AADwB,KAExBA,OAAOC,WAAP,CAAmB,OAAnB,EAA4B,OAA5B,CAFK;;AAKA,SAASL,UAAT,CAAoBS,GAApB,EAAiCC,KAAjC,EAAkD;AACvD,MAAMC,UAAU,sBAAW,EAAEC,SAAS,IAAX,EAAX,EAA8BH,GAA9B,CAAhB;AACAE,UAAQE,WAAR,CAAoB,QAApB,EAA8B,EAAEH,KAAF,EAA9B;AACA,SAAOC,QAAQG,MAAR,CAAeC,SAAf,EAAP;AACD;;AAEM,SAASd,UAAT,CACLQ,GADK,EAELO,IAFK,EAWL;AACA,MAAM;AACJN,SADI;AAEJO,eAFI;AAGJC,aAHI;AAIJC,MAJI;AAKJC,KALI;AAMJC,KANI;AAOJC;AAPI,MAQFN,IARJ;AASA,MAAMO,OAAO,sBAAW,EAAEX,SAAS,IAAX,EAAX,EAA8BH,GAA9B,CAAb;AACAc,OAAKC,WAAL,CAAiB;AACfC,OAAc,gBADC;AAEfN,MAFe;AAGfC,KAHe;AAIfC,KAJe;AAKfX,SALe;AAMfgB,kBAAcT,WANC;AAOfU,eAAcL;AAPC,GAAjB,EAQG,gBARH,EAQqB,gBARrB;;AAWA,MAAMM,OAAOL,KAAKM,aAAL,EAAb;AACA,MAAMC,eAAe,wBAAcP,KAAKT,MAAL,CAAYC,SAAZ,EAAd,EAAuCgB,MAAvC,CAA8CH,IAA9C,CAArB;;AAGA,MAAMjB,UAAU,sBAAW,EAAEC,SAAS,IAAX,EAAX,EAA8BH,GAA9B,CAAhB;AACAE,UAAQE,WAAR,CAAoB,eAApB,EAAqC;AACnCH,SADmC;AAEnCgB,kBAAwBT,WAFW;AAGnCG,KAHmC;AAInCC,KAJmC;AAKnCW,4BAAwBd,UAAUe,WALC;AAMnCC,oBAAwB,qBAAWhB,SAAX,EAAsBY,YAAtB;AANW,GAArC;AAQA,SAAOnB,QAAQG,MAAR,CAAeC,SAAf,EAAP;AACD;;AAEM,SAASb,YAAT,CACLO,GADK,EAELO,IAFK,EAOLmB,EAPK,EAQL;AACA,MAAM;AACJzB,SADI;AAEJO;AAFI,MAGFD,IAHJ;AAIA,MAAMO,OAAO,sBAAW,EAAEX,SAAS,IAAX,EAAX,EAA8BH,GAA9B,CAAb;;AAEAc,OAAKC,WAAL,CAAiB;AACfC,OAAc,sBADC;AAEff,SAFe;AAGfgB,kBAAcT,WAHC;AAIfmB,cAAc,CAAC,CAAD,EAAIpB,KAAKqB,KAAL,EAAJ,CAJC;AAKfC,SAAcH;AALC,GAAjB,EAMG,sBANH,EAM2B,WAN3B;;AAQA,MAAMP,OAAOL,KAAKM,aAAL,EAAb;AACA,SAAO,wBAAcN,KAAKT,MAAL,CAAYC,SAAZ,EAAd,EAAuCgB,MAAvC,CAA8CH,IAA9C,CAAP;AACD","file":"fetch-object.js","sourcesContent":["//@flow\n\nimport { Deserialization as Reader, Serialization as Writer } from '../../tl'\nimport { rsaEncrypt, sha1BytesSync } from '../../bin'\n\nimport {\n  type ResPQ,\n  type Server_DH_Params,\n  type Server_DH_inner_data,\n  type Set_client_DH_params_answer,\n} from './index.h'\nimport { type PublicKeyExtended } from '../main/index.h'\n\n\n\nexport const fetchDHInner = (reader: Reader): Server_DH_inner_data =>\n  //$off\n  reader.fetchObject('Server_DH_inner_data', 'server_dh')\n\nexport const fetchDhParam = (reader: Reader): Set_client_DH_params_answer =>\n  //$off\n  reader.fetchObject('Set_client_DH_params_answer', 'client_dh')\n\nexport const fetchServerDh = (reader: Reader): Server_DH_Params =>\n  //$off\n  reader.fetchObject('Server_DH_Params', 'RESPONSE')\n\nexport const fetchResPQ = (reader: Reader): ResPQ =>\n  //$off\n  reader.fetchObject('ResPQ', 'ResPQ')\n\n\nexport function writeReqPQ(uid: string, nonce: number[]) {\n  const request = new Writer({ mtproto: true }, uid)\n  request.storeMethod('req_pq', { nonce })\n  return request.writer.getBuffer()\n}\n\nexport function writeReqDH(\n  uid: string,\n  auth: {\n    nonce: number[],\n    serverNonce: number[],\n    publicKey: PublicKeyExtended,\n    pq: number[],\n    p: number[],\n    q: number[],\n    newNonce: number[],\n  }\n) {\n  const {\n    nonce,\n    serverNonce,\n    publicKey,\n    pq,\n    p,\n    q,\n    newNonce,\n  } = auth\n  const data = new Writer({ mtproto: true }, uid)\n  data.storeObject({\n    _           : 'p_q_inner_data',\n    pq,\n    p,\n    q,\n    nonce,\n    server_nonce: serverNonce,\n    new_nonce   : newNonce\n  }, 'P_Q_inner_data', 'DECRYPTED_DATA')\n\n\n  const hash = data.getBytesPlain()\n  const dataWithHash = sha1BytesSync(data.writer.getBuffer()).concat(hash)\n\n\n  const request = new Writer({ mtproto: true }, uid)\n  request.storeMethod('req_DH_params', {\n    nonce,\n    server_nonce          : serverNonce,\n    p,\n    q,\n    public_key_fingerprint: publicKey.fingerprint,\n    encrypted_data        : rsaEncrypt(publicKey, dataWithHash)\n  })\n  return request.writer.getBuffer()\n}\n\nexport function writeInnerDH(\n  uid: string,\n  auth: {\n    nonce: number[],\n    serverNonce: number[],\n    retry: number,\n  },\n  gB: number[]\n) {\n  const {\n    nonce,\n    serverNonce,\n  } = auth\n  const data = new Writer({ mtproto: true }, uid)\n\n  data.storeObject({\n    _           : 'client_DH_inner_data',\n    nonce,\n    server_nonce: serverNonce,\n    retry_id    : [0, auth.retry++],\n    g_b         : gB\n  }, 'Client_DH_Inner_Data', 'client_DH')\n\n  const hash = data.getBytesPlain()\n  return sha1BytesSync(data.writer.getBuffer()).concat(hash)\n}"]}